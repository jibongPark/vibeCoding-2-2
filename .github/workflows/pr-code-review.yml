name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Changed Files
      id: changed-files
      run: |
        # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt
        echo "files<<EOF" >> $GITHUB_OUTPUT
        cat changed_files.txt >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Auto Code Review
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.payload.pull_request.number;
          const files = `${{ steps.changed-files.outputs.files }}`.split('\n').filter(f => f.trim());
          
          let reviewComments = [];
          let generalComments = [];
          
          // íŒŒì¼ë³„ ìë™ ë¦¬ë·° ë¡œì§
          for (const file of files) {
            if (!file.trim()) continue;
            
            // Python íŒŒì¼ ì²´í¬
            if (file.endsWith('.py')) {
              generalComments.push(`ğŸ“ **${file}**: Python íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:
              - [ ] PEP 8 ìŠ¤íƒ€ì¼ ê°€ì´ë“œ ì¤€ìˆ˜
              - [ ] íƒ€ì… íŒíŠ¸ ì ìš©
              - [ ] Docstring ì‘ì„±`);
            }
            
            // í…ŒìŠ¤íŠ¸ íŒŒì¼ ì²´í¬
            if (file.includes('test_') || file.includes('/tests/')) {
              generalComments.push(`ğŸ§ª **${file}**: í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
              - [ ] í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì»¤ë²„ë¦¬ì§€ í™•ì¸
              - [ ] ì—£ì§€ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸ í¬í•¨`);
            }
            
            // API ê´€ë ¨ íŒŒì¼ ì²´í¬
            if (file.includes('router') || file.includes('api')) {
              generalComments.push(`ğŸŒ **${file}**: API ê´€ë ¨ íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
              - [ ] API ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•„ìš”ì„± ê²€í† 
              - [ ] ì—ëŸ¬ í•¸ë“¤ë§ í™•ì¸
              - [ ] ë³´ì•ˆ ê²€í†  í•„ìš”`);
            }
            
            // ì„¤ì • íŒŒì¼ ì²´í¬
            if (file.includes('requirements.txt') || file.includes('.env')) {
              generalComments.push(`âš™ï¸ **${file}**: ì„¤ì • íŒŒì¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.
              - [ ] ìƒˆë¡œìš´ ì˜ì¡´ì„±ì— ëŒ€í•œ ë³´ì•ˆ ê²€í† 
              - [ ] ë²„ì „ ì¶©ëŒ ê°€ëŠ¥ì„± ê²€í† `);
            }
          }
          
          // ì¼ë°˜ì ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸
          generalComments.push(`## ğŸ” ìë™ ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸
          
          ### ì½”ë“œ í’ˆì§ˆ
          - [ ] ì½”ë“œê°€ Clean Architecture ì›ì¹™ì„ ë”°ë¥´ê³  ìˆëŠ”ê°€?
          - [ ] SOLID ì›ì¹™ì´ ì ìš©ë˜ì—ˆëŠ”ê°€?
          - [ ] í•¨ìˆ˜ì™€ í´ë˜ìŠ¤ê°€ ë‹¨ì¼ ì±…ì„ì„ ê°–ê³  ìˆëŠ”ê°€?
          
          ### í…ŒìŠ¤íŠ¸
          - [ ] ìƒˆë¡œìš´ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì‘ì„±ë˜ì—ˆëŠ”ê°€?
          - [ ] ê¸°ì¡´ í…ŒìŠ¤íŠ¸ê°€ ì—¬ì „íˆ í†µê³¼í•˜ëŠ”ê°€?
          
          ### ë¬¸ì„œí™”
          - [ ] ì½”ë“œ ë³€ê²½ì‚¬í•­ì´ ë¬¸ì„œì— ë°˜ì˜ë˜ì—ˆëŠ”ê°€?
          - [ ] API ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ë©´ ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆëŠ”ê°€?
          
          ### ë³´ì•ˆ
          - [ ] ë³´ì•ˆ ì·¨ì•½ì ì´ ì—†ëŠ”ê°€?
          - [ ] ë¯¼ê°í•œ ì •ë³´ê°€ í•˜ë“œì½”ë”©ë˜ì§€ ì•Šì•˜ëŠ”ê°€?`);
          
          // ë¦¬ë·° ëŒ“ê¸€ ìƒì„±
          const fullComment = generalComments.join('\n\n');
          
          try {
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: fullComment,
              event: 'COMMENT'
            });
            
            console.log(`PR #${prNumber}ì— ìë™ ì½”ë“œ ë¦¬ë·°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          } catch (error) {
            console.log(`ë¦¬ë·° ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
          } 